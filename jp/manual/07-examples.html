<!DOCTYPE html>
<html>
<head>
  <title>例から学ぶ Rundeck</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="author" content="Alex Honor" />
  <meta name="author" content="Greg Schueler" />
  <meta name="date" content="November 20, 2010" />
<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">

<!-- Optional theme -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap-theme.min.css">

<script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript">
jQuery(function(){ jQuery('table').addClass('table table-condensed table-responsive'); });
</script>
  <style type="text/css">
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; }
code > span.dt { color: #902000; }
code > span.dv { color: #40a070; }
code > span.bn { color: #40a070; }
code > span.fl { color: #40a070; }
code > span.ch { color: #4070a0; }
code > span.st { color: #4070a0; }
code > span.co { color: #60a0b0; font-style: italic; }
code > span.ot { color: #007020; }
code > span.al { color: #ff0000; font-weight: bold; }
code > span.fu { color: #06287e; }
code > span.er { color: #ff0000; font-weight: bold; }
  </style>
  <link rel="stylesheet" href="../style.css" type="text/css" />
</head>
<body data-spy="scroll" data-target=".toc-nav">
<nav class="navbar navbar-inverse navbar-static-top" role="navigation">
  <!-- Brand and toggle get grouped for better mobile display -->
  <div class="container-fluid">
  <div class="navbar-header">
    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
      <span class="sr-only">Toggle navigation</span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </button>
    <a class="navbar-brand" href="http://rundeck.org/index.html">
      Rundeck
      <p class="small rd_version">Job Scheduler and Runbook Automation</p>
    </a>
  </div>
  <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
    <ul class="nav navbar-nav">
    
    <li class="item about selected">
      <a href="http://rundeck.org/about.html">
        About
        <p class="small">News, Videos, Docs</p>
      </a>
    </li>
    <li class="item help">
      <a href="http://rundeck.org/help.html">
        Get Help
        <p class="small">IRC List Tracker</p>
      </a>
    </li>
    <li class="item plugins ">
      <a href="http://rundeck.org/plugins/index.html">
        Plugins
        <p class="small">Integrate Rundeck</p>
      </a>
    </li>
    <li class="item downloads  omega">
    <a href="http://rundeck.org/downloads.html">
      Download
      <p class="small rd_version">2.5.3</p>
      </a>
    </li>
    </ul>
    <form class="navbar-form navbar-left" role="search"  action="http://rundeck.org/search/">
      <div class="form-group">
        <input type="text" class="form-control" name="q" placeholder="Search">
      </div>
      <button type="submit" class="btn btn-default">Submit</button>
    </form>
  </div>
  </div>
</nav>

<div class="container top breadcrumb_holder">
<div class="row">
<div class="col-sm-6">
<ol class="breadcrumb top">

    
        <li><a href="../index.html">Rundeck ドキュメント (2.5.3)</a></li>
    
    
    <li ><a href="index.html">ユーザーマニュアル</a></li>
    <li class="active"><a href="07-examples.html">例から学ぶ Rundeck</a></li>
</ol>
</div>
<div class="col-sm-6">
    <ul class="pager">
      <li class="previous"><a href="06-job-options.html"><i class="glyphicon glyphicon-arrow-left"></i> ジョブのオプション</a></li>
      <li class="next"><a href="08-plugins.html">プラグイン <i class="glyphicon glyphicon-arrow-right"></i></a></li>
    </ul>
</div>
</div>
</div>
<div id="docbody">
<div class="container">
<div class="row">
<div class="col-sm-3 toc-nav">
<div class="nav">
<ul>
<li><a href="#acme-anvils">Acme Anvils</a></li>
<li><a href="#rundeck-のセットアップ">Rundeck のセットアップ</a></li>
<li><a href="#タグ付けとコマンドディスパッチング">タグ付けとコマンドディスパッチング</a></li>
<li><a href="#ジョブ">ジョブ</a><ul>
<li><a href="#ジョブの構造">ジョブの構造</a></li>
<li><a href="#ジョブのグルーピング">ジョブのグルーピング</a></li>
</ul></li>
<li><a href="#ジョブのオプション">ジョブのオプション</a><ul>
<li><a href="#許可された値">許可された値</a></li>
<li><a href="#オプションデータへのスクリプトからのアクセス">オプションデータへのスクリプトからのアクセス</a></li>
</ul></li>
<li><a href="#ジョブワークフローを作る">ジョブワークフローを作る</a></li>
<li><a href="#ジョブを実行する">ジョブを実行する</a></li>
<li><a href="#ジョブのアクセスコントロール">ジョブのアクセスコントロール</a></li>
<li><a href="#リソースモデルソースの例">リソースモデルソースの例</a></li>
<li><a href="#リソースエディタの例">リソースエディタの例</a></li>
<li><a href="#オプションモデルプロバイダーの例">オプションモデルプロバイダーの例</a></li>
</ul>
</div>
</div>
<div class="col-sm-9">
<div class="page-header">
<h1 class="title">例から学ぶ Rundeck</h1>
</div>
<p>この章では、Rundeck を用いた様々なソリューションを表す実践例を説明します。出てくる例は、これまでの章で紹介した概念や機能を実践する際の助けとなることに焦点を当てています。抽象的な例を挙げるのではなく、オンラインアプリケーションサービスを経営する架空の組織 Acme Avils の状況に合わせた例を挙げていきます。</p>
<h2 id="acme-anvils"><a href="#acme-anvils">Acme Anvils</a></h2>
<p>Acme Anvils はオンラインで新品・中古の金敷き台 (anvils) を売っている架空のスタートアップです。会社の中には金敷き台を売るアプリケーションの開発とサポートに関わる 2 つのチームが存在します。まだ新しい会社なので、本番環境へのアクセスはしっかり管理されていません。どちらのチームにもソースコードの変更によってミスや障害を起こす可能性があります。シニアマネージャー達がチームに新しい機能のリリースを出来る限り頻繁にさせようと夢中になっているからです。残念ながら、これは別の問題を引き起こしていました：Acme Anvil のウェブサイトは、メモリを大量に喰い、偶発的にリスタートが起こっていたのです。</p>
<p>リスタート処理には 2 つの方法があります: &quot;kill&quot; と &quot;normal&quot; です。&quot;kill&quot; でのリスタートには、アプリケーションが一切レスポンスしなくても良い時間が必要になります。&quot;normal&quot; でのリスタートには、十分な量のメモリを必要とします。</p>
<p>緊急事態または急いでいる状況下で、開発者がリスタートの実行を行うのか、システムの管理者がリスタートの実行を行うのかは全く別物です。なぜならソフトウェアを書いている開発者は、アプリケーションの観点からリスタートの必要性について理解しており、一方それらの必要性を知らされてないシステム管理社はシステムの観点からリスタートについて理解しています。これがやり方の違いを生む、顧客に対して影響を及ぼす主原因でした。</p>
<p>あるシステム管理者はアプリケーションをリスタートさせるよう深夜に電話がかかってくることにうんざりしていました。また開発と運用の知識の溝にイライラしていました。彼はもっと良いアプローチでやっていくために先導を取っていくことを決めました。</p>
<h2 id="rundeck-のセットアップ"><a href="#rundeck-のセットアップ">Rundeck のセットアップ</a></h2>
<p>管理者は本番環境のサーバーにアクセスするためのマシンを用意してそこに Rundeck をインストールすることにしました。</p>
<p>アプリケーションサポートに関することを管理するためにプロジェクト名 &quot;anvils&quot; を作りました。</p>
<p>管理者はシェルツール <a href="../manpages/man1/rd-project.html">rd-project</a> を使ってプロジェクトを作成します。これは Rundeck GUI (<a href="rundeck-basics.html#rundeck+のセットアップ">プロジェクトのセットアップ</a>を参照)からでも可能です。Rundeck サーバーにログインし、以下のコマンドを実行します:</p>
<pre><code>rd-project -p anvils -a create</code></pre>
<p>このコマンドにより &quot;anvils&quot; プロジェクトが Rundeck 上に作られ、そこには Rundeck サーバーに当たるノード情報のみが含まれています。本番環境に置かれたノード情報の追加についてはこれから説明します。(<a href="getting-started.html#リソースモデル">リソースモデル</a> を参照)</p>
<p>本番環境には anv1 から anv5 までの 5 つのノードが存在します。アプリケーションは 3 階層あります。ウェブ、アプリケーション、データベースのコンポーネントが 5 つのノードにまたがってインストールされています。</p>
<p>さらに管理者はアプリケーションのコンポーネントをコントロールする SSH コマンドを実行するのに、それぞれ違ったログインユーザーを使うようルールを敷くことに決めます。ウェブコンポーネントには &quot;www&quot; というユーザー、アプリケーションとデータベースコンポーネントには &quot;anvils&quot; というユーザーを用います。</p>
<p>このルールをきちんと管理するために、管理者は <a href="../manpages/man5/resource-v13.html">resource-v13(5) XML</a> または <a href="../manpages/man5/resource-yaml-v13.html">resource-v13(5) YAML</a> を使ったプロジェクトリソースモデルを準備します。下記の定義ファイルには、5 つのノードの定義がリストアップされています -- anv1, anv2, anv3, anv4, anv5</p>
<p>File listing: resources.xml</p>
<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;

&lt;project&gt;
  &lt;node name=&quot;anv1&quot; type=&quot;Node&quot;
     description=&quot;an anvils web server&quot; 
     hostname=&quot;anv1.acme.com&quot;  username=&quot;www&quot; tags=&quot;web&quot;/&gt;
  &lt;node name=&quot;anv2&quot; type=&quot;Node&quot; 
     description=&quot;an anvils web server&quot; 
     hostname=&quot;anv2.acme.com&quot;  username=&quot;www&quot; tags=&quot;web&quot;/&gt;
  &lt;node name=&quot;anv3&quot; type=&quot;Node&quot; 
     description=&quot;an avnils app server&quot; 
     hostname=&quot;anv3.acme.com&quot;  username=&quot;anvils&quot; tags=&quot;app&quot;/&gt;
  &lt;node name=&quot;anv4&quot; type=&quot;Node&quot; 
     description=&quot;an anvils app server&quot; 
     hostname=&quot;anv4.acme.com&quot;  username=&quot;anvils&quot; tags=&quot;app&quot;/&gt;
  &lt;node name=&quot;anv5&quot; type=&quot;Node&quot; 
     description=&quot;the anvils database server&quot; 
     hostname=&quot;anv5.acme.com&quot;  username=&quot;anvils&quot; tags=&quot;db&quot;/&gt; 
&lt;/project&gt;</code></pre>
<p>XML コンテンツを見てみると、全体に渡って XML タグでホスト情報が表されています。各ノードの論理名は、<code>name</code> 属性に定義します。(例 name=&quot;anv1&quot;) <code>hostname</code> 属性で定義されたアドレス(例 hostname=&quot;anv1.acme.com&quot;) は <code>username</code> 属性にて指定されたログインユーザー(例 username=&quot;www&quot;)が SSH コマンドを実行する際に利用されます。<code>tags</code> 属性で定義された値は、ノードの役割/機能を表しています。(例 tags=&quot;web&quot; vs tags=&quot;app&quot;)</p>
<p>管理者は彼が決めたパスにファイルを保存します。Rundeck にそのファイルを認識させるために、プロジェクトの設定ファイルを編集する必要があります、<code>$RDECK_BASE/projects/anvils/etc/project.properties</code> の <code>project.resources.file</code> を編集します:</p>
<pre><code>project.resources.file = /etc/rundeck/projects/anvils/resources.xml</code></pre>
<p>リソースファイルを置きプロジェクト設定を更新すれば、管理者としてのリソースモデルの準備とディスパッチコマンドを実行する準備が整ったことになります。</p>
<p>フィルタを開け、<code>.*</code> を名前フィールドに入力し、&quot;Filter&quot; を押して、anvils プロジェクトのすべてのノードをリストアップします。6 つのノードが出ているはずです。</p>
<div class="figure">
<img src="../figures/fig0601.png" alt="Anvils resources" /><p class="caption">Anvils resources</p>
</div>
<h2 id="タグ付けとコマンドディスパッチング"><a href="#タグ付けとコマンドディスパッチング">タグ付けとコマンドディスパッチング</a></h2>
<p>アプリケーションの役割を表すタグを使うと、ターゲットとなるホスト名を一切ハードコーディングせずにコマンド実行が可能になります。<a href="../manpages/man1/dispatch.html">dipatch</a> コマンドにて、指定したタグによりフィルタリングされたノードセットをリストアップできます:</p>
<p>web ノードをリストアップするタグのキーワードを使います:</p>
<pre><code>dispatch -p anvils -I tags=web
anv1 anv2</code></pre>
<p>app ノードのリストアップ:</p>
<pre><code>dispatch -p anvils -I tags=app
anv3 anv4</code></pre>
<p>db ノードのリストアップ:</p>
<pre><code>dispatch -p anvils -I tags=db
anv5</code></pre>
<p>&quot;+&quot; (AND) 演算子を使って web と app ノードをリストアップします:</p>
<pre><code>dispatch -p anvils -I tags=web+app
anv1 anv2 anv3 anv4</code></pre>
<p>web と app ノードを除きます</p>
<pre><code>dispatch -p anvils -X tags=web+app
anv5</code></pre>
<p>ノード名にワイルドカードを使って、全てのノードをリストアップします:</p>
<pre><code>dispatch -p anvils -I &#39;.*&#39; 
anv1 anv2 anv3 anv4 anv5 </code></pre>
<p>以下の図はグラフィカルコンソールでのフィルタリングの使用例です。</p>
<div class="figure">
<img src="../figures/fig0602.png" alt="Anvils filtered list" /><p class="caption">Anvils filtered list</p>
</div>
<p>タグによるフィルタリング機能によってホスト郡が抽象化され、管理者はゆるやかな分類を使ったスクリプトの処理について考えられます。新しいノードの追加も可能ですし、既に役割を与えられているホスト郡からその役割を外すことも可能です、そして、それぞれフィルタリング条件に紐づけられるため、各役割における処理に影響はありません。</p>
<p>この簡単な分類の仕組みは、開発者と管理者に Anvils アプリケーションのノードについて話す際の共通用語となります。</p>
<h2 id="ジョブ"><a href="#ジョブ">ジョブ</a></h2>
<p>ジョブは繰り返し実行する処理のライブラリをつくる便利な方法です。その性質上、保存されたジョブは処理をカプセル化する働きをします。ジョブは小さな、または大きなシェルスクリプトを呼ぶような 1 つのワークフローから、マルチステップのワークフローまで扱う事が出来ます。各ジョブを再利用可能な処理のブロックとして捉えると、より複雑な自動化を構築することができます。</p>
<p>起動とシャットダウンの処理の管理用として既に 2 つのスクリプトセットが存在していました。管理者は、どちらのスクリプトの方が優れているかといったことを強要することよりも、ジョブワークフローによってどのようにスクリプトがカプセル化されるかを簡単に示すために骨組みを作ることに専念しました。このシンプルなフレームワークについてのデモを行った後、管理者はジョブの定義に両方のスクリプト合わせた一番いいものを入れるにはどうしたらいいか議論することができます。</p>
<p>管理者は、骨組みとして実行しようとしていることと、与えられた引数をただ echo するだけのシンプルなプレースホルダースクリプトを作りました - start.sh と stop.sh - リスタートの処理を 2 つのステップで表現しています。</p>
<p>スクリプト:</p>
<p>File listing: start.sh</p>
<pre><code>#!/bin/sh
# Usage: $0 
echo Web started.</code></pre>
<p>File listing: stop.sh</p>
<pre><code>#!/bin/sh
# Usage: $0 [normal|kill]
echo Web stopped with method: $1.</code></pre>
<p>&quot;method&quot; オプションにて normal または kill のどちらの方法か指定できるようになっているため、ユーザーはスクリプトに引数を与える必要があります。</p>
<p>リスタート処理はジョブワークフローとして定義されるため、リスタートの処理にそのまま対応するスクリプトは存在しません。</p>
<h3 id="ジョブの構造"><a href="#ジョブの構造">ジョブの構造</a></h3>
<p>リスタートスクリプトのアイデアを念頭に置き、次のステップでは、リスタートの処理を含んだジョブの定義をします。最終的なゴールは、リスタートの処理をひとつ提供し、再利用できるように各ステップ毎にジョブを分けた方がいいでしょう。</p>
<p>管理者は以下のようなアプローチをイメージしています:</p>
<ul>
<li>スタート: ウェブサービスをスタートさせるために start.sh スクリプトを実行する</li>
<li>ストップ: ウェブサービスをストップさせるために stop.sh スクリプトを実行する</li>
<li>リスタート: ストップジョブ、スタートジョブの順番で実行する</li>
</ul>
<p>リスタートの処理が優先的であるため、大文字にして差別化しています。</p>
<p>後々の管理を考えて将来出てくるジョブと既存のジョブが結合できるようジョブを全ての個々のステップ毎に定義しようとすると大変複雑になってきますが、これは後からでもできることです。どのように処理を個々のジョブに分解するかは、保守性と再利用性のバランスを考えて決めます。</p>
<h3 id="ジョブのグルーピング"><a href="#ジョブのグルーピング">ジョブのグルーピング</a></h3>
<p>絶対必要というわけではないですが、ジョブのグルーピングとその命名規則を決めておくと便利です。優れた命名規則は名前を思い出しやすく、探している処理を見つけやすくしてくれます。</p>
<p>管理者はウェブサービスのリスタートに関連するジョブが置かれるトップレベルのグループを &quot;/anvils/web&quot; という名前にしました。</p>
<pre><code>anvils/
`-- web/
    |-- Restart
    |-- start
    `-- stop</code></pre>
<p>&quot;anvils&quot; プロジェクトを選択後、このジョブグループがあることがわかります。</p>
<div class="figure">
<img src="../figures/fig0604.png" alt="Anvils job group" /><p class="caption">Anvils job group</p>
</div>
<h2 id="ジョブのオプション"><a href="#ジョブのオプション">ジョブのオプション</a></h2>
<p>スクリプトにてリスタートの方法を指定するために、先ほどの 3 つのジョブにて &quot;method&quot; というオプションを作ります。それらのパラメーターが無い場合、管理者は kill と normal の両方のストップ方法についてリスタートジョブを用意することになります。</p>
<p>ジョブオプションを定義するもう一つのメリットは、ジョブを実行しようとした際に選択肢のひとつとしてメニューに表示されることです。選択するとメニューから選択した値がスクリプトに渡されます。</p>
<h3 id="許可された値"><a href="#許可された値">許可された値</a></h3>
<p>定義できるオプションは、指定されたリスト内にあるものに限ります。これは安全にスクリプトを利用できるようパラメーターの選択肢を制限してジョブを実行するセーフガードの役割を担います。</p>
<p>管理者はこれを利用して、&quot;normal&quot; または &quot;kill&quot; のみ選択可能になるよう &quot;method&quot; オプションにて制限をかけます。</p>
<p>以下のスクリーンショットは、&quot;method&quot; オプションを編集しているところです。フォームにはオプションの説明とデフォルトの値だけでなく、Allowed Values (許可された値) と Restrictions (制限) の項目が入っています。</p>
<div class="figure">
<img src="../figures/fig0605.png" alt="Option editor for method" /><p class="caption">Option editor for method</p>
</div>
<p>上述のように 許可された値はカンマ区切りのリストで指定できます、また &quot;remote URL&quot; を使った外部リソースからも可能です。</p>
<p>&quot;Enforced from Allowed values (許可された値のみという強要)&quot; という制約を使ってオプションの選択肢を管理できます。&quot;true&quot; をセットしたとき、Rundeck UI は許可された値のみ選択可能なようポップメニューだけ表示されます。&quot;false&quot; をセットしたときは、テキストフィールドも表示されます。&quot;Match Regular Expression&quot; を使って入力をバリデートすることもできます。</p>
<p>Rundeck がどのようにメニューの選択肢を表示するかのスクリーンショットが以下になります。</p>
<div class="figure">
<img src="../figures/fig0606.png" alt="Option menu for method" /><p class="caption">Option menu for method</p>
</div>
<h3 id="オプションデータへのスクリプトからのアクセス"><a href="#オプションデータへのスクリプトからのアクセス">オプションデータへのスクリプトからのアクセス</a></h3>
<p>オプション値は引数または参照値としてスクリプトに渡す事ができ、スクリプト内で名前を付けたトークンとして利用できます。例えば、&quot;method&quot; オプションの値にアクセスするにはいくつかの方法があります:</p>
<p>環境変数として参照する:</p>
<ul>
<li>Bash: $CT_OPTION_METHOD</li>
</ul>
<p><code>srciptargs</code> タグを使ってスクリプトやコマンドの引数として値を渡します:</p>
<ul>
<li>Commandline Arguments: ${option.method}</li>
</ul>
<p>スクリプト内である名前が作られたトークンとして値が展開され、実行前に置き換わります:</p>
<ul>
<li>Script Content: <span class="citation">@option.method</span>@</li>
</ul>
<h2 id="ジョブワークフローを作る"><a href="#ジョブワークフローを作る">ジョブワークフローを作る</a></h2>
<p>リスタート処理を管理するのに必要なスクリプトとオプションを理解した上で、ジョブの定義を作っていくのが最後のステップになります。</p>
<p>Rundeck の GUI からもドキュメントフォーマット <a href="../manpages/man5/job-v20.html">job-v20(5)</a>に従った XML 形式で各ジョブを定義できます。このドキュメントフォーマットには Rundeck GUI フォームの中での選択肢に相当するタグセットについても書かれています。</p>
<p>以下にあるのはジョブについての XML の定義です。1 つの XML ファイルに 1 つ以上のジョブが定義できますが、どのように定義するかはあなたが決めるルール次第です。ファイルも好きなように名前を付けることが出来ます、必ずしもジョブ名やそのグループに相当する名前である必要はありません。</p>
<p>File listing: stop.xml</p>
<pre><code>&lt;joblist&gt;   
    &lt;job&gt; 
       &lt;name&gt;stop&lt;/name&gt;  
       &lt;description&gt;the web stop procedure&lt;/description&gt;  
       &lt;loglevel&gt;INFO&lt;/loglevel&gt;  
       &lt;group&gt;anvils/web&lt;/group&gt;  
       &lt;context&gt; 
           &lt;project&gt;anvils&lt;/project&gt;  
             &lt;options&gt; 
               &lt;option name=&quot;method&quot; enforcedvalues=&quot;true&quot;
                       required=&quot;true&quot; 
                   values=&quot;normal,kill&quot;/&gt; 
               &lt;/options&gt; 
       &lt;/context&gt;  
       &lt;sequence threadcount=&quot;1&quot; keepgoing=&quot;false&quot; strategy=&quot;node-first&quot;&gt; 
         &lt;command&gt; 
           &lt;script&gt;&lt;![CDATA[#!/bin/sh
echo Web stopped with method: $1.]]&gt;&lt;/script&gt;  
            &lt;scriptargs&gt;${option.method}&lt;/scriptargs&gt; 
         &lt;/command&gt; 
       &lt;/sequence&gt;  
       &lt;nodefilters excludeprecedence=&quot;true&quot;&gt; 
         &lt;include&gt; 
          &lt;tags&gt;web&lt;/tags&gt; 
          &lt;/include&gt; 
       &lt;/nodefilters&gt;  
       &lt;dispatch&gt; 
         &lt;threadcount&gt;1&lt;/threadcount&gt;  
         &lt;keepgoing&gt;false&lt;/keepgoing&gt; 
       &lt;/dispatch&gt; 
     &lt;/job&gt;
&lt;/joblist&gt;</code></pre>
<p>/anvils/web/stop というジョブを定義します、これは &quot;web&quot; というタグが付いたノードに対してシェルスクリプトを実行します。<code>scripttags</code> を使ってシェルスクリプトにジョブの実行フォームから選択された値を含んだ引数 <code>${option.method}</code> をひとつ渡します。</p>
<p>File listing: start.xml</p>
<pre><code>&lt;joblist&gt;   
   &lt;job&gt; 
     &lt;name&gt;start&lt;/name&gt;  
     &lt;description&gt;the web start procedure&lt;/description&gt;  
     &lt;loglevel&gt;INFO&lt;/loglevel&gt;  
     &lt;group&gt;anvils/web&lt;/group&gt;  
    &lt;context&gt; 
      &lt;project&gt;anvils&lt;/project&gt;  
    &lt;/context&gt;  
    &lt;sequence threadcount=&quot;1&quot; keepgoing=&quot;false&quot; strategy=&quot;node-first&quot;&gt; 
     &lt;command&gt; 
      &lt;script&gt;&lt;![CDATA[#!/bin/sh
 echo Web started.]]&gt;&lt;/script&gt;
     &lt;/command&gt; 
  &lt;/sequence&gt;  
    &lt;nodefilters excludeprecedence=&quot;true&quot;&gt; 
      &lt;include&gt; 
        &lt;tags&gt;web&lt;/tags&gt; 
      &lt;/include&gt; 
   &lt;/nodefilters&gt;  
   &lt;dispatch&gt; 
     &lt;threadcount&gt;1&lt;/threadcount&gt;  
     &lt;keepgoing&gt;false&lt;/keepgoing&gt; 
   &lt;/dispatch&gt; 
  &lt;/job&gt;
&lt;/joblist&gt;</code></pre>
<p>/anvils/web/start というジョブを定義します、これは &quot;web&quot; というタグが付いたノードに対してシェルスクリプトを実行します。</p>
<p>File listing: restart.xml</p>
<pre><code>&lt;joblist&gt;   
   &lt;job&gt; 
     &lt;name&gt;Restart&lt;/name&gt;  
     &lt;description&gt;restart the web server&lt;/description&gt;  
     &lt;loglevel&gt;INFO&lt;/loglevel&gt;  
     &lt;group&gt;anvils/web&lt;/group&gt;  
     &lt;context&gt; 
       &lt;project&gt;anvils&lt;/project&gt;  
         &lt;options&gt; 
           &lt;option name=&quot;method&quot; enforcedvalues=&quot;true&quot; required=&quot;false&quot; 
          values=&quot;normal,kill&quot; /&gt; 
        &lt;/options&gt; 
     &lt;/context&gt;  
     &lt;sequence threadcount=&quot;1&quot; keepgoing=&quot;false&quot; strategy=&quot;node-first&quot;&gt; 
      &lt;command&gt; 
        &lt;jobref name=&quot;stop&quot; group=&quot;anvils/web&quot;&gt;
          &lt;arg line=&quot;-method ${option.method}&quot;/&gt; 
        &lt;/jobref&gt; 
      &lt;/command&gt;  
      &lt;command&gt; 
        &lt;jobref name=&quot;start&quot; group=&quot;anvils/web&quot;&gt;
        &lt;/jobref&gt; 
      &lt;/command&gt; 
    &lt;/sequence&gt;
   &lt;/job&gt;   
&lt;/joblist&gt;</code></pre>
<p>/anvils/web/Restart というジョブを定義します、これは <code>jobref</code> タグを用いて連続するジョブ郡を実行します</p>
<p>今回は <code>&lt;nodefilters&gt;</code> または <code>&lt;dispatch&gt;</code> の項目を定義していないことに注意してください、今回はこの連続実行をサーバー上で<strong>一度だけ</strong>しか行わないからです。ジョブリファレンスはそれぞれ 1 回呼ばれ、&quot;start&quot; と &quot;stop&quot; ジョブはそれぞれ定義されているノードに対してディスパッチされます。</p>
<p>XML の定義ファイルを Rundeck サーバーに保存すると、<a href="../manpages/man1/rd-jobs.html">rd-jobs</a> コマンドを用いてそれらを読み込む事ができます。</p>
<p><code>rd-jobs</code> を実行して各ジョブの定義ファイルからコマンドを読み込みます:</p>
<pre><code>rd-jobs load -f start.xml
rd-jobs load -f stop.xml
rd-jobs load -f restart.xml</code></pre>
<p><code>rd-jobs list</code> コマンドは Rundeck に定義済みのジョブのリストを出力するよう問い合わせます:</p>
<pre><code>rd-jobs list -p anvils
Found 3 jobs:
- Restart - &#39;the web restart procedure&#39;
- start - &#39;the web start procedure&#39;
- stop - &#39;the web stop procedure&#39;</code></pre>
<p>もちろん、これらのジョブは Rundeck のグラフィカルコンソールの Jobs ページからも見る事ができます。ジョブ名 &quot;Restart&quot; の上にホバリングオーバーしてジョブの詳細が表示されます。</p>
<div class="figure">
<img src="../figures/fig0607.png" alt="Anvils restart jobs" /><p class="caption">Anvils restart jobs</p>
</div>
<p>ここまでで、各ジョブ(ストップとスタート)を呼ぶワークフローとして &quot;Restart&quot; ジョブの組み立て方を理解したことでしょう。&quot;Restart&quot; ジョブは <code>-method</code> オプションの値をより低レベルのストップジョブに渡します。</p>
<h2 id="ジョブを実行する"><a href="#ジョブを実行する">ジョブを実行する</a></h2>
<p>ジョブは Rundeck のグラフィカルコンソールの &quot;Jobs&quot; ページから実行できます。ここから、3 つの保存済みジョブが表示される &quot;Anvils/web&quot; ジョブグループまでナビゲートします。</p>
<p>&quot;Run&quot; ボタンをクリックしてジョブをリスタートさせます。するとオプションを選択するページが表示されます。&quot;method&quot; オプションについてのメニューが 2 つの選択肢 &quot;normal&quot; と &quot;kill&quot; を表示しています。他の選択肢や自由に入力できるテキストフィールドは利用できません、&quot;method&quot; オプションが選択肢を限定するように定義されているからです。</p>
<div class="figure">
<img src="../figures/fig0608.png" alt="Restart run page" /><p class="caption">Restart run page</p>
</div>
<p>シェルツール <a href="../manpages/man1/run.html">run</a> を使ってコマンドラインからもジョブを起動することができます。&quot;-j&quot; パラメーターを使ってジョブグループとジョブ名を指定してください。ジョブがサポートするあらゆるオプションは &quot;--&quot; パラメーターの後に指定します。(&quot;-p&quot; パラメーターはプロジェクトの指定に用います、しかし利用可能なプロジェクトが 1 つしか無い場合は指定しなくてもよいです。)</p>
<p>&quot;normal&quot; メソッドを指定してリスタートジョブを実行します:</p>
<pre><code>run -j &quot;anvils/web/Restart&quot; -p anvils -- -method normal</code></pre>
<p>&quot;kill&quot; メソッドを指定してリスタートジョブを実行します:</p>
<pre><code>run -j &quot;anvils/web/Restart&quot; -p anvils -- -method kill</code></pre>
<h2 id="ジョブのアクセスコントロール"><a href="#ジョブのアクセスコントロール">ジョブのアクセスコントロール</a></h2>
<p>ジョブの編集または実行へのアクセス管理は、ACL ポリシードキュメントフォーマット（<a href="../manpages/man5/aclpolicy-v10.html">aclpolicy-v10(5)</a>） を使って定義できます。このファイルは、どのユーザーグループがどんなアクションが行えるのかを記述したポリシー要素で構成されています。この詳細は管理者向けガイドにおける<a href="../administration/authorization.html">権限の許可(Authorization)</a> の章に載っています。</p>
<p>管理者は 2 つのアクセスレベルを定義した ACL ポリシーを使いたいと思っています。最初のレベルはジョブをただ実行することだけが許されます。2 つ目のレベルは、管理者作業とジョブの定義を編集できます。</p>
<p>ポリシー機能は、グループまたは利用パターンごとのアクセス管理情報をひとつまたは複数のポリシーファイルにまとめることができます。普通にインストールした Rundeck には 2 つのユーザーグループが定義されています: &quot;admin&quot; と &quot;user&quot; です。そして &quot;admin&quot; グループについてポリシーが作られています。</p>
<p>Acme 社の管理者は、&quot;user&quot; グループに入っている人たちが &quot;anvils&quot; と &quot;anvlis/web&quot; ジョブグループの実行のみ許可されるようなポリシーを 1 つ作る事に決めました。私たちは Rundeck を普通どおりインストールしたときに入っている &quot;user&quot; ログイングループを利用する事が出来ます。</p>
<p>&quot;user&quot; グループに対してのポリシーファイルを作る方法:</p>
<pre><code>cp $RDECK_BASE/etc/admin.aclpolicy $RDECK_BASE/etc/user.aclpolicy</code></pre>
<p>以下の例にあるように <code>&lt;command&gt;</code> と <code>&lt;group&gt;</code> 要素を編集します。workflow_read と workflow_run アクションのみ許可されていることがわかります。</p>
<pre class="sourceCode xml"><code class="sourceCode xml">$ cat $RDECK_BASE/etc/user.aclpolicy
<span class="kw">&lt;policies&gt;</span>
  <span class="kw">&lt;policy</span><span class="ot"> description=</span><span class="st">&quot;User group access policy.&quot;</span><span class="kw">&gt;</span>
    <span class="kw">&lt;context</span><span class="ot"> project=</span><span class="st">&quot;*&quot;</span><span class="kw">&gt;</span>
      <span class="kw">&lt;command</span><span class="ot"> group=</span><span class="st">&quot;anvils&quot;</span><span class="ot"> job=</span><span class="st">&quot;*&quot;</span><span class="ot"> actions=</span><span class="st">&quot;workflow_read,workflow_run&quot;</span><span class="kw">/&gt;</span>
      <span class="kw">&lt;command</span><span class="ot"> group=</span><span class="st">&quot;anvils/web&quot;</span><span class="ot"> job=</span><span class="st">&quot;*&quot;</span><span class="ot"> actions=</span><span class="st">&quot;workflow_read,workflow_run&quot;</span><span class="kw">/&gt;</span>
    <span class="kw">&lt;/context&gt;</span>
    <span class="kw">&lt;by&gt;</span>
      <span class="kw">&lt;group</span><span class="ot"> name=</span><span class="st">&quot;user&quot;</span><span class="kw">/&gt;</span>
    <span class="kw">&lt;/by&gt;</span>
  <span class="kw">&lt;/policy&gt;</span>
<span class="kw">&lt;/policies&gt;</span></code></pre>
<p>新しいポリシーファイルを読み込ませるために Rundeck をリスタートします。（<a href="../administration/startup-and-shutdown.html">管理者向けガイド - 起動とシャットダウン</a> を参照してください）</p>
<pre><code>rundeckd restart</code></pre>
<p>Rundeck ウェブアプリケーションを起動して、&quot;user&quot; ユーザーとしてログインします (パスワードは多分 &quot;user&quot; )。起動すると Jobs ページに &quot;anvils&quot; グループだけ表示されています。&quot;user&quot; ユーザーは &quot;/anvils&quot; グループ以外のジョブへのアクセス権限はありません。</p>
<p>&quot;admin&quot; としてログインすると表示される &quot;New Job&quot; ボタンがないことに気付きます。ジョブの作成権限は &quot;user&quot; には付与されていません。また、リストアップされたジョブについてのボタンバーにジョブの編集や削除アイコンが付いていないことにも気付きます。<code>user.aclpolicy</code> ファイルにて workflow_read と workflow_actions のみ許可されています。</p>
<h2 id="リソースモデルソースの例"><a href="#リソースモデルソースの例">リソースモデルソースの例</a></h2>
<p><a href="../administration/node-resource-sources.html#リソースモデルソース">管理者向けガイド - ノードリソースソース - リソースモデルソース</a> を参照してください。</p>
<h2 id="リソースエディタの例"><a href="#リソースエディタの例">リソースエディタの例</a></h2>
<p><a href="../administration/node-resource-sources.html#リソースエディタ">管理者向けガイド- ノードリソースソース - リソースエディタ</a> を参照してください。</p>
<h2 id="オプションモデルプロバイダーの例"><a href="#オプションモデルプロバイダーの例">オプションモデルプロバイダーの例</a></h2>
<p><a href="http://rundeck.org/docs/manual/job-options.html#オプションモデルプロバイダ">ジョブオプション - オプションモデルプロバイダ</a> を参照してください。</p>
</div>
</div>
</div>
</div>

<div class="container bottom breadcrumb_holder">
<div class="row">
<div class="col-sm-6">
<ol class="breadcrumb bottom">

    
        <li><a href="../index.html">Rundeck ドキュメント (2.5.3)</a></li>
    
    
    <li ><a href="index.html">ユーザーマニュアル</a></li>
    <li class="active"><a href="07-examples.html">例から学ぶ Rundeck</a></li>
</ol>
</div>
<div class="col-sm-6">
    <ul class="pager">
      <li class="previous"><a href="06-job-options.html"><i class="glyphicon glyphicon-arrow-left"></i> ジョブのオプション</a></li>
      <li class="next"><a href="08-plugins.html">プラグイン <i class="glyphicon glyphicon-arrow-right"></i></a></li>
    </ul>
</div>
</div>
</div>
<div class='container footer'>

<div class="row">
<footer class="copy col-sm-12 text-muted">

<span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/Text" property="dct:title" rel="dct:type">Rundeck Documentation</span> by <a xmlns:cc="http://creativecommons.org/ns#" href="http://dtosolutions.com" property="cc:attributionName" rel="cc:attributionURL">SimplifyOps</a> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/">Creative Commons Attribution-ShareAlike 3.0 Unported License</a>.
<p>
&copy;2014 <a href="http://simplifyops.com">#SimplifyOps</a>
</p>
<p>
<span class="generated-date" title="2015-08-12T22:25:37UTC">2015-08-12T22:25:37UTC</span>
</p>
</footer>
</div>
</div>
<script type="text/javascript">
  

   var _gaq = [['_setAccount', 'UA-529275-13'], ['_trackPageview']];
   (function(d, t) {
    var g = d.createElement(t),
        s = d.getElementsByTagName(t)[0];
    g.async = true;
    g.src = ('https:' == location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    s.parentNode.insertBefore(g, s);
   })(document, 'script');
  </script>
</body>
</html>
